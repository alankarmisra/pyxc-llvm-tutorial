# test_ast.pyxc - compile/link smoke tests for ast.pyxc

struct NumberExprAST:
    node_type: i32
    value: f64
    is_int: i32
    int_value: i64

struct VariableExprAST:
    node_type: i32
    name: ptr[i8]

struct BinaryExprAST:
    node_type: i32
    op: i8
    lhs: ptr[i8]
    rhs: ptr[i8]

struct PrototypeAST:
    node_type: i32
    name: ptr[i8]
    params: ptr[ptr[i8]]
    param_types: ptr[ptr[i8]]
    num_params: i32
    return_type: ptr[i8]
    is_extern: i32

struct FunctionAST:
    node_type: i32
    proto: ptr[PrototypeAST]
    body: ptr[ptr[i8]]
    body_count: i32

extern def create_number_expr(val: f64, is_int: i32, int_val: i64) -> ptr[NumberExprAST]
extern def create_variable_expr(name: ptr[i8]) -> ptr[VariableExprAST]
extern def create_binary_expr(op: i8, lhs: ptr[i8], rhs: ptr[i8]) -> ptr[BinaryExprAST]
extern def create_return_stmt(value: ptr[i8]) -> ptr[i8]
extern def create_prototype(name: ptr[i8], params: ptr[ptr[i8]], param_types: ptr[ptr[i8]], num_params: i32, return_type: ptr[i8], is_extern: i32) -> ptr[PrototypeAST]
extern def create_function(proto: ptr[PrototypeAST], body: ptr[ptr[i8]], body_count: i32) -> ptr[FunctionAST]

extern def free_expr(expr: ptr[i8]) -> void
extern def free_prototype(proto: ptr[PrototypeAST]) -> void
extern def free_function(func: ptr[FunctionAST]) -> void

def make_i32_string() -> ptr[i8]:
    s: ptr[i8] = malloc[i8](4)
    s[0] = 105
    s[1] = 51
    s[2] = 50
    s[3] = 0
    return s

def make_one_char_string(ch: i8) -> ptr[i8]:
    s: ptr[i8] = malloc[i8](2)
    s[0] = ch
    s[1] = 0
    return s

def test_expr_nodes() -> void:
    printf("Testing expression nodes...\n")

    n: ptr[NumberExprAST] = create_number_expr(42.0, 1, 42)
    v: ptr[VariableExprAST] = create_variable_expr("x")
    b: ptr[BinaryExprAST] = create_binary_expr(43, v, n)

    printf("  number: type=%d int_val=%lld\n", n[0].node_type, n[0].int_value)
    printf("  variable: type=%d name=%s\n", v[0].node_type, v[0].name)
    printf("  binary: type=%d op=%c\n", b[0].node_type, b[0].op)

    free_expr(b)
    printf("  PASS\n\n")

def test_function_nodes() -> void:
    printf("Testing prototype/function nodes...\n")

    params: ptr[ptr[i8]] = malloc[ptr[i8]](2)
    param_types: ptr[ptr[i8]] = malloc[ptr[i8]](2)

    params[0] = make_one_char_string(97)
    params[1] = make_one_char_string(98)
    param_types[0] = make_i32_string()
    param_types[1] = make_i32_string()

    proto: ptr[PrototypeAST] = create_prototype("add", params, param_types, 2, "i32", 0)
    body: ptr[ptr[i8]] = malloc[ptr[i8]](1)
    body[0] = create_return_stmt(create_number_expr(1.0, 1, 1))
    func: ptr[FunctionAST] = create_function(proto, body, 1)

    printf("  prototype: type=%d name=%s params=%d ret=%s\n", proto[0].node_type, proto[0].name, proto[0].num_params, proto[0].return_type)
    printf("  function: type=%d body_count=%d\n", func[0].node_type, func[0].body_count)

    free_function(func)
    printf("  PASS\n\n")

def main() -> i32:
    printf("=== AST Tests ===\n\n")
    test_expr_nodes()
    test_function_nodes()
    printf("=== All Tests Passed ===\n")
    return 0

main()
